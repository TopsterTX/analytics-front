name: Build Docker Image

on:
  workflow_call:
    inputs:
      image_name:
        description: "Docker image tag"
        required: true
        type: string
      registry_url:
        description: "Docker image tag"
        required: true
        type: string
      registry_password:
        description: "Docker image tag"
        required: true
        type: string
      registry_username:
        description: "Docker image tag"
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 23

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build application
        run: yarn build --production

      - name: Build Docker image
        run: docker build -t ${{inputs.registry_url}}/${{ inputs.image_name }} .

      - name: Configure Docker for HTTP registry
        run: |
          echo '{ "insecure-registries": ["${{ inputs.registry_url }}"] }' | sudo tee /etc/docker/daemon.json
          sudo systemctl restart docker

      - name: Log in to Docker Registry
        run: echo ${{ inputs.registry_password }} | docker login ${{ inputs.registry_url }} -u ${{ inputs.registry_username }} --password-stdin

      - name: Push Docker image to registry
        run: |
          docker tag analytics-front-main ${{ inputs.registry_url }}/${{ inputs.image_name }} 
          docker push ${{ inputs.registry_url }}/${{ inputs.image_name }} 

